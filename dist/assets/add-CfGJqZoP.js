import{_ as Fe,a as $e}from"./ClientFinalAddDialog-V6krAe57.js";import{_ as Oe,a as Le}from"./CustomRadiosWithIcon-lg34bO5N.js";import{_ as qe}from"./IconBtn-DDZ12Udw.js";import{_ as Be}from"./AppDateTimePicker-DtxdjnaA.js";import{r as s,x as M,o as ze,h as W,a as _,d as a,b as l,c as w,f as x,w as t,i as m,u,k as Me,g as I,t as r,V as Q,l as j,F as Ve,j as Te}from"./index-C2VmLSsf.js";import{$ as re}from"./api-fBbxbWV9.js";import{V as Z}from"./VCard-BsRs2Dbz.js";import{V as de}from"./VCardText-fQi82b2X.js";import{V as U,a as i}from"./VRow-CKub-qAo.js";import{V as _e}from"./VSelect-Ce3hOZLi.js";import{V as ee}from"./VTextField-BvYPkTzd.js";import{V as G}from"./VAlert-ku1xFGr_.js";import{V as je}from"./VAutocomplete-CE6caHRp.js";import{V as Ge}from"./VCheckbox-q5itUquS.js";import{V as Ee}from"./VTable-Rng3EBBw.js";import{V as He}from"./VTextarea-x2-n2yy5.js";import"./DialogCloseBtn-CDkbfzzn.js";import"./VForm-CT43qB3J.js";import"./forwardRefs-DWGaNmQL.js";import"./VDialog-DJHst2CE.js";import"./VOverlay-BuiK-fz4.js";import"./VImg-BjZkJGgN.js";import"./VRadioGroup-DKDXMjv1.js";import"./VCheckboxBtn-D1ZcYjYr.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./index-BYrzgnBV.js";import"./VAvatar-CrWFUmzB.js";/* empty css              */import"./VList-C6VPgDKA.js";import"./VDivider-IUxUQjJr.js";import"./VMenu-Dk04Zlg9.js";import"./VChip-DLC_ftk3.js";import"./filter-BT5ZVbsJ.js";const Xe=a("div",{class:"d-flex flex-wrap justify-space-between gap-4 mb-6"},[a("div",{class:"d-flex flex-column justify-center"},[a("h4",{class:"text-h4 mb-1"},"ðŸ›ï¸ AÃ±adir Nueva Venta / CotizaciÃ³n"),a("p",{class:"text-body-1 mb-0"})])],-1),Ye=a("b",null,"Cliente:",-1),Je=a("br",null,null,-1),Ke=a("b",null,"N.Âº Documento:",-1),We=a("p",{class:"my-0"},"Â¿Regalo?",-1),Qe=a("thead",null,[a("tr",null,[a("th",{class:"text-uppercase"},"Producto"),a("th",{class:"text-uppercase"},"Unidad"),a("th",{class:"text-uppercase"},"Precio unitario"),a("th",{class:"text-uppercase"},"Cantidad"),a("th",{class:"text-uppercase"},"Descuento"),a("th",{class:"text-uppercase"},"Impuesto"),a("th",{class:"text-uppercase"},"Subtotal"),a("th",{class:"text-uppercase"},"Total"),a("th",{class:"text-uppercase"},"AcciÃ³n")])],-1),Ze={style:{"white-space":"nowrap"}},el={style:{"white-space":"nowrap"}},ll={style:{"white-space":"nowrap"}},tl={style:{"white-space":"nowrap"}},al={style:{"white-space":"nowrap"}},ul={style:{width:"100%"}},ol=a("td",null,"Impuestos",-1),nl=a("td",null,"Descuento",-1),sl=a("td",null,"Subtotal",-1),il=a("td",null,"Total",-1),rl=a("thead",null,[a("tr",null,[a("th",{class:"text-uppercase"},"MÃ©todo de pago"),a("th",{class:"text-uppercase"},"Importe"),a("th",{class:"text-uppercase"},"AcciÃ³n")])],-1),dl=a("td",null,"Total",-1),cl=a("td",null,null,-1),ml=a("td",null,"Deuda",-1),vl=a("td",null,null,-1),Jl={__name:"add",setup(pl){const O=s(!1),H=s(!1),X=s(!1),Y=s(null),le=s(null),fe=s([]),S=s(null),P=s(null),L=s([]),T=s(null),te=s(null),ae=s([]),f=s(null),k=s(0),v=s(0),E=s(1),D=s(0),g=s([]),ue=s(0),oe=s(0),ne=s(0),C=s(0),A=s([]),q=s(null),F=s(0),h=s(0),$=s(null),R=s(null),se=s(null),b=o=>{const e=Number(o??0);try{return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e)}catch{return`${e.toLocaleString("es-ES")} â‚¬`}},ce=s(!1),B=s(),d=s(null),me=s([]),y=s(null),ie=s(null),Ce=o=>{ce.value=!0,setTimeout(async()=>{try{const e=await re("sales/search_product?search="+(B.value?B.value:""),{method:"GET",onResponseError({response:p}){console.log(p._data.error)}});me.value=e.products.data,ce.value=!1}catch(e){console.log(e)}},500)};M(B,o=>{if(y.value=null,ie.value=null,!S.value){setTimeout(()=>{y.value="Es necesario seleccionar un almacÃ©n antes de escoger un producto"},25);return}if(!T.value){setTimeout(()=>{ie.value="Es necesario seleccionar un cliente antes de escoger un producto"},25);return}(o||"").length>3?Ce():me.value=[]}),M(d,o=>{o&&(ae.value=o.warehouses.filter(e=>e.warehouse_id==S.value).map(e=>({id:e.unit_id,name:e.unit.name})),J())}),M(S,o=>{d.value&&(ae.value=d.value.warehouses.filter(e=>e.warehouse_id==o).map(e=>({id:e.unit_id,name:e.unit.name})),J())}),M(f,o=>{if(!o)return;if(E.value==2){v.value=0,D.value=0;return}const e=o,p=T.value.type_client,z=JSON.parse(localStorage.getItem("user"));let c=d.value.wallets.find(V=>V.type_client==p&&V.unit_id==e&&V.sucursale_id==z.sucursale_id);c?v.value=c.price:(c=d.value.wallets.find(V=>V.type_client==p&&V.unit_id==e&&V.sucursale_id==null),c?v.value=c.price:v.value=p==1?d.value.price_general:d.value.price_company)}),M(E,o=>{if(o==2)v.value=0,D.value=0;else if(d.value){const e=f.value;f.value="",setTimeout(()=>{f.value=e},25)}});const he=[{title:"Venta",value:"1",icon:"ri-shopping-cart-line"},{title:"CotizaciÃ³n",value:"2",icon:"ri-file-list-line"}],N=s("1");M(N,o=>{o==2&&(A.value=[],pe(),h.value=0)});const Ne=async()=>{try{const o=await re("sales/config",{method:"GET",onResponseError({response:p}){console.log(p._data.error)}});le.value=o.today;const e=JSON.parse(localStorage.getItem("user"));fe.value=o.warehouses.filter(p=>p.sucursale_id==e.sucursale_id)}catch(o){console.log(o)}},we=async()=>{O.value=!1,T.value=null,te.value=null;try{const o=await re("sales/search_client?search="+(P.value?P.value:""),{method:"GET",onResponseError({response:e}){console.log(e._data.error)}});L.value=o.clients,L.value.length==1?ve(L.value[0]):(L.value.length==0&&(te.value="No se encontrÃ³ ninguna coincidencia"),setTimeout(()=>{O.value=!0},25))}catch(o){console.log(o)}},be=o=>{ve(o)},ve=o=>{T.value=o,P.value=o.full_name,J()},J=()=>{v.value=0,f.value="",E.value=1,D.value=0,k.value=0},xe=()=>{if(y.value=null,!f.value){setTimeout(()=>{y.value="Es necesario seleccionar una unidad"},25);return}if(E.value==1&&(!v.value||v.value==0)){setTimeout(()=>{y.value="Es necesario ingresar un precio"},25);return}if(!k.value||k.value==0){setTimeout(()=>{y.value="Es necesario ingresar una cantidad"},25);return}E.value==2&&(v.value=0,D.value=0);const o=ae.value.find(c=>c.id==f.value);let e=0;d.value.tax_selected==2?e=0:e=Number(v.value)*(d.value.importe_iva*.01);const p=Number(v.value)-Number(D.value)+e;if(g.value.find(c=>c.product.id==d.value.id&&c.unit_id==f.value)){setTimeout(()=>{y.value="El producto y la unidad ya existe en el detalle, seleccione otro"},25);return}if(d.value.is_discount==2){const c=d.value.max_discount*.01*Number(v.value);if(c<Number(D.value)){setTimeout(()=>{y.value="El descuento mÃ¡ximo del producto es: "+b(c)},25);return}}if(N.value==1&&d.value.disponibilidad==2){const c=d.value.warehouses.find(V=>V.warehouse_id==S.value&&V.unit_id==f.value);if(c&&parseInt(c.stock)<parseInt(k.value)){setTimeout(()=>{y.value="El stock disponible de este producto es "+c.stock},25);return}}g.value.push({product:d.value,unit_id:f.value,unit:o,warehouse_id:S.value,price:v.value,quantity:k.value,discount:D.value,is_gift:E.value,igv:e.toFixed(2),subtotal:p.toFixed(2),total:(p*parseInt(k.value)).toFixed(2)}),setTimeout(()=>{ye(),J()},25)},ye=()=>{ue.value=g.value.reduce((o,e)=>o+Number(e.igv)*Number(e.quantity),0),oe.value=g.value.reduce((o,e)=>o+Number(e.discount)*Number(e.quantity),0),ne.value=g.value.reduce((o,e)=>o+Number(e.price)*Number(e.quantity),0),C.value=g.value.reduce((o,e)=>o+Number(e.total),0)},Se=o=>{y.value=null;const e=g.value[o].total;if(C.value-e<h.value){setTimeout(()=>{y.value="No se puede eliminar este producto porque el pago cancelado es mayor"},25);return}g.value.splice(o,1),setTimeout(()=>{ye()},25)},De=()=>{if($.value=null,!q.value){setTimeout(()=>{$.value="El mÃ©todo de pago se tiene que seleccionar"},25);return}if(F.value==0){setTimeout(()=>{$.value="El importe de pago debe ser mayor a 0"},25);return}if(C.value==0){setTimeout(()=>{$.value="El total de la venta debe ser mayor a 0 para aÃ±adir un pago"},25);return}if(Number(h.value)+Number(F.value)>Number(C.value)){setTimeout(()=>{$.value="El total pagado no puede ser mayor al total de la venta"},25);return}A.value.unshift({method_payment:q.value,amount:Number(F.value)}),ge(),pe()},Ue=o=>{A.value.splice(o,1),ge()},ge=()=>{h.value=A.value.reduce((o,e)=>o+e.amount,0)},pe=()=>{q.value="",F.value=0},ke=()=>{A.value=[],Y.value="",g.value=[],S.value="",T.value=null,P.value="",C.value=0,ue.value=0,ne.value=0,oe.value=0,h.value=0,pe(),J()},Ie=async()=>{try{if(R.value=null,se.value=null,g.value.length==0){setTimeout(()=>{R.value="Es necesario agregar un producto al detallado"},25);return}if(!S.value){setTimeout(()=>{R.value="Es necesario seleccionar un almacÃ©n para la venta"},25);return}if(!T.value){setTimeout(()=>{R.value="Es necesario seleccionar un cliente para la venta"},25);return}if(N.value==1&&A.value.length==0){setTimeout(()=>{R.value="Es necesario dar un adelanto para la venta"},25);return}let o=1;N.value==1&&(h.value!=C.value&&(o=2),h.value==C.value&&(o=3));const e={client_id:T.value.id,type_client:T.value.type_client,discount:oe.value,subtotal:ne.value,total:C.value,igv:ue.value,state_sale:N.value,state_payment:o,debt:C.value-h.value,paid_out:h.value,description:Y.value,sale_details:g.value,payments:A.value},p=await re("sales",{method:"POST",body:e,onResponseError({response:z}){R.value=z._data.error}});console.log(p),se.value="La "+(N.value==1?"VENTA":"COTIZACIÃ“N")+" se ha registrado correctamente",ke()}catch(o){console.log(o)}};return ze(()=>{Ne()}),(o,e)=>{const p=Oe,z=Be,c=qe,V=Le,Ae=Fe,Re=$e;return _(),W("div",null,[Xe,l(Z,{class:"mb-6 py-4 px-4"},{default:t(()=>[l(p,{"selected-radio":u(N),"onUpdate:selectedRadio":e[0]||(e[0]=n=>m(N)?N.value=n:null),"radio-content":he,"grid-column":{sm:"6",cols:"12"}},null,8,["selected-radio"])]),_:1}),l(Z,{class:"mb-6"},{default:t(()=>[l(de,null,{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"3"},{default:t(()=>[l(z,{modelValue:u(le),"onUpdate:modelValue":e[1]||(e[1]=n=>m(le)?le.value=n:null),label:"Fecha de emisiÃ³n",placeholder:"Selecciona fecha"},null,8,["modelValue"])]),_:1}),l(i,{cols:"3"},{default:t(()=>[l(_e,{items:u(fe),"item-title":"name","item-value":"id",placeholder:"Selecciona",modelValue:u(S),"onUpdate:modelValue":e[2]||(e[2]=n=>m(S)?S.value=n:null),label:"Almacenes"},null,8,["items","modelValue"])]),_:1}),l(i,{cols:"4"},{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"12"},{default:t(()=>[l(ee,{label:"Cliente",modelValue:u(P),"onUpdate:modelValue":e[3]||(e[3]=n=>m(P)?P.value=n:null),"prepend-inner-icon":"ri-user-6-line",placeholder:"",onKeyup:e[4]||(e[4]=Me(n=>we(),["enter"]))},null,8,["modelValue"])]),_:1}),u(T)?(_(),w(i,{key:0,cols:"12 py-0"},{default:t(()=>[a("span",null,[Ye,I(" "+r(u(T).full_name),1)]),Je,a("span",null,[Ke,I(" "+r(u(T).n_document),1)])]),_:1})):x("",!0),u(te)?(_(),w(i,{key:1,cols:"12 py-0"},{default:t(()=>[l(G,{closable:"","close-label":"Cerrar",color:"warning"},{default:t(()=>[I(r(u(te)),1)]),_:1})]),_:1})):x("",!0)]),_:1})]),_:1}),l(i,{cols:"2"},{default:t(()=>[l(Q,{color:"secondary",class:"mx-2",onClick:e[5]||(e[5]=n=>H.value=!u(H))},{default:t(()=>[l(j,{icon:"ri-user-add-line"})]),_:1}),l(Q,{color:"secondary",onClick:e[6]||(e[6]=n=>X.value=!u(X))},{default:t(()=>[l(j,{icon:"ri-community-line"})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(Z,{class:"mb-6"},{default:t(()=>[l(de,null,{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"7"},{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"12"},{default:t(()=>[l(je,{modelValue:u(d),"onUpdate:modelValue":e[7]||(e[7]=n=>m(d)?d.value=n:null),search:u(B),"onUpdate:search":e[8]||(e[8]=n=>m(B)?B.value=n:null),loading:u(ce),items:u(me),"item-title":"title","item-value":"id","return-object":"",placeholder:"Buscar producto",label:"Â¿QuÃ© agregamos?",variant:"underlined","menu-props":{maxHeight:"200px"}},null,8,["modelValue","search","loading","items"])]),_:1}),u(y)?(_(),w(i,{key:0,cols:"12"},{default:t(()=>[l(G,{closable:"","close-label":"Cerrar",color:"warning"},{default:t(()=>[I(r(u(y)),1)]),_:1})]),_:1})):x("",!0),u(ie)?(_(),w(i,{key:1,cols:"12"},{default:t(()=>[l(G,{closable:"","close-label":"Cerrar",color:"warning"},{default:t(()=>[I(r(u(ie)),1)]),_:1})]),_:1})):x("",!0)]),_:1})]),_:1}),l(i,{cols:"5"},{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"10"},{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"4"},{default:t(()=>[l(_e,{items:u(ae),"item-title":"name","item-value":"id",placeholder:"Selecciona",modelValue:u(f),"onUpdate:modelValue":e[9]||(e[9]=n=>m(f)?f.value=n:null),label:"Unidades"},null,8,["items","modelValue"])]),_:1}),l(i,{cols:"4"},{default:t(()=>[l(ee,{label:"Precio",type:"number",modelValue:u(v),"onUpdate:modelValue":e[10]||(e[10]=n=>m(v)?v.value=n:null),disabled:u(E)==2?!0:null},null,8,["modelValue","disabled"])]),_:1}),l(i,{cols:"4"},{default:t(()=>[l(ee,{label:"Cantidad",type:"number",modelValue:u(k),"onUpdate:modelValue":e[11]||(e[11]=n=>m(k)?k.value=n:null)},null,8,["modelValue"])]),_:1}),u(d)&&u(d).is_gift==2?(_(),w(i,{key:0,cols:"4"},{default:t(()=>[We,l(Ge,{label:"SÃ­",value:"2",modelValue:u(E),"onUpdate:modelValue":e[12]||(e[12]=n=>m(E)?E.value=n:null)},null,8,["modelValue"])]),_:1})):x("",!0),u(d)&&u(d).is_discount==2?(_(),w(i,{key:1,cols:"4"},{default:t(()=>[l(ee,{label:"Descuento",type:"number",modelValue:u(D),"onUpdate:modelValue":e[13]||(e[13]=n=>m(D)?D.value=n:null),disabled:u(E)==2?!0:null},null,8,["modelValue","disabled"])]),_:1})):x("",!0)]),_:1})]),_:1}),l(i,{cols:"2"},{default:t(()=>[l(Q,{color:"primary",onClick:e[14]||(e[14]=n=>xe())},{default:t(()=>[l(j,{icon:"ri-add-circle-line"})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(Z,{class:"mb-6"},{default:t(()=>[l(de,null,{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"12"},{default:t(()=>[l(Ee,null,{default:t(()=>[Qe,a("tbody",null,[(_(!0),W(Ve,null,Te(u(g),(n,K)=>(_(),W("tr",{key:K},[a("td",null,r(n.product.title),1),a("td",null,r(n.unit.name),1),a("td",Ze,r(b(n.price)),1),a("td",null,r(n.quantity),1),a("td",el,r(b(n.discount)),1),a("td",ll,r(b(n.igv)),1),a("td",tl,r(b(n.subtotal)),1),a("td",al,r(b(n.total)),1),a("td",null,[l(c,{size:"small",onClick:Pe=>Se(K)},{default:t(()=>[l(j,{icon:"ri-delete-bin-line"})]),_:2},1032,["onClick"])])]))),128))])]),_:1})]),_:1}),l(i,{cols:"7"}),l(i,{cols:"5"},{default:t(()=>[a("table",ul,[a("tr",null,[ol,a("td",null,r(b(u(ue))),1)]),a("tr",null,[nl,a("td",null,r(b(u(oe))),1)]),a("tr",null,[sl,a("td",null,r(b(u(ne))),1)]),a("tr",null,[il,a("td",null,r(b(u(C))),1)])])]),_:1})]),_:1})]),_:1})]),_:1}),l(Z,{class:"mb-6"},{default:t(()=>[l(de,null,{default:t(()=>[l(U,null,{default:t(()=>[u(N)==1?(_(),w(i,{key:0,cols:"8"},{default:t(()=>[l(U,null,{default:t(()=>[l(i,{cols:"4"},{default:t(()=>[l(_e,{placeholder:"Selecciona",label:"MÃ©todos de pago",items:["EFECTIVO","DEPOSITO","TRANSFERENCIA","YAPE","PLIN"],modelValue:u(q),"onUpdate:modelValue":e[15]||(e[15]=n=>m(q)?q.value=n:null)},null,8,["modelValue"])]),_:1}),l(i,{cols:"4"},{default:t(()=>[l(ee,{label:"Importe",type:"number",modelValue:u(F),"onUpdate:modelValue":e[16]||(e[16]=n=>m(F)?F.value=n:null)},null,8,["modelValue"])]),_:1}),l(i,{cols:"4"},{default:t(()=>[l(Q,{color:"primary",onClick:e[17]||(e[17]=n=>De())},{default:t(()=>[l(j,{icon:"ri-add-circle-line"})]),_:1})]),_:1}),u($)?(_(),w(i,{key:0,cols:"12"},{default:t(()=>[l(G,{closable:"","close-label":"Cerrar",color:"warning"},{default:t(()=>[I(r(u($)),1)]),_:1})]),_:1})):x("",!0)]),_:1}),l(U,null,{default:t(()=>[l(i,{cols:"10"},{default:t(()=>[l(Ee,null,{default:t(()=>[rl,a("tbody",null,[(_(!0),W(Ve,null,Te(u(A),(n,K)=>(_(),W("tr",{key:K},[a("td",null,r(n.method_payment),1),a("td",null,r(b(n.amount)),1),a("td",null,[l(c,{size:"small",onClick:Pe=>Ue(K)},{default:t(()=>[l(j,{icon:"ri-delete-bin-line"})]),_:2},1032,["onClick"])])]))),128)),a("tr",null,[dl,a("td",null,r(b(u(h))),1),cl]),a("tr",null,[ml,a("td",null,r(b((u(C)-u(h)).toFixed(2))),1),vl])])]),_:1})]),_:1})]),_:1})]),_:1})):x("",!0),l(i,{cols:"4"},{default:t(()=>[l(He,{label:"DescripciÃ³n",modelValue:u(Y),"onUpdate:modelValue":e[18]||(e[18]=n=>m(Y)?Y.value=n:null)},null,8,["modelValue"])]),_:1}),u(R)?(_(),w(i,{key:1,cols:"12"},{default:t(()=>[l(G,{closable:"","close-label":"Cerrar",color:"warning"},{default:t(()=>[I(r(u(R)),1)]),_:1})]),_:1})):x("",!0),u(se)?(_(),w(i,{key:2,cols:"12"},{default:t(()=>[l(G,{closable:"","close-label":"Cerrar",color:"success"},{default:t(()=>[I(r(u(se)),1)]),_:1})]),_:1})):x("",!0),l(i,{cols:"12"},{default:t(()=>[l(Q,{block:"",onClick:Ie},{default:t(()=>[I(" Crear "+r(u(N)==1?"Ventas":"CotizaciÃ³n"),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),u(L).length>0&&u(O)?(_(),w(V,{key:0,isDialogVisible:u(O),"onUpdate:isDialogVisible":e[19]||(e[19]=n=>m(O)?O.value=n:null),listClients:u(L),onClientSelected:ve},null,8,["isDialogVisible","listClients"])):x("",!0),l(Ae,{isDialogVisible:u(H),"onUpdate:isDialogVisible":e[20]||(e[20]=n=>m(H)?H.value=n:null),onAddClient:be},null,8,["isDialogVisible"]),l(Re,{isDialogVisible:u(X),"onUpdate:isDialogVisible":e[21]||(e[21]=n=>m(X)?X.value=n:null),onAddClient:be},null,8,["isDialogVisible"])])}}};export{Jl as default};
